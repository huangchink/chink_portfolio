# Overwrite the offline HTML with new default values matching the provided screenshot.
html = r"""<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSMC 分紅與薪資計算器（離線版）</title>
  <style>
    :root { --bg:#0b1020; --panel:#121933; --accent:#6aa6ff; --text:#e6ecff; --muted:#9fb3ff33; }
    * { box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif; background:linear-gradient(120deg,#0a0f1e,#101935 40%,#0b1020); color:var(--text); }
    header{ padding:20px; text-align:center; border-bottom:1px solid #2a335a; }
    header h1{ margin:0; font-size:20px; letter-spacing:0.5px; }
    header p{ margin:8px auto 0; max-width:900px; color:#c9d6ff; opacity:.9; font-size:14px; line-height:1.6; }
    main{ padding:18px; display:grid; grid-template-columns: 420px 1fr; gap:18px; align-items:start; max-width:1200px; margin:0 auto; }
    @media (max-width: 980px){ main{ grid-template-columns:1fr; } }
    .card{ background: radial-gradient(1200px 1200px at -10% -10%, #1a2550 10%, transparent 50%) , var(--panel);
           border:1px solid #2b3666; border-radius:16px; box-shadow: 0 10px 30px #0006 inset, 0 6px 20px #0006; }
    .card .head{ padding:14px 16px; border-bottom:1px solid #26315b; display:flex; align-items:center; gap:10px; }
    .card .head h2{ margin:0; font-size:16px; }
    .card .body{ padding:16px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    label{ font-size:12px; color:#cfe1ff; display:block; margin-bottom:6px; }
    input[type="number"], input[type="text"], select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid #33407a; background:#0e1430; color:#e9f0ff;
      outline:none; box-shadow: 0 0 0 0 rgba(106,166,255,.35);
    }
    input[type="number"]:focus, input[type="text"]:focus{ border-color:#6aa6ff; box-shadow: 0 0 0 3px rgba(106,166,255,.15); }
    .hint{ color:#cfe1ffcc; font-size:12px; margin-top:8px; }
    .muted{ color:#b1c4ff99; font-size:12px; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      cursor:pointer; border:1px solid #35519a; background: linear-gradient(#27407e,#1e2f66);
      color:#e7f0ff; border-radius:12px; padding:10px 14px; font-weight:600; letter-spacing:.2px;
      transition: transform .04s ease, filter .2s ease, box-shadow .2s ease;
    }
    button:hover{ filter:brightness(1.05); box-shadow: 0 0 0 3px rgba(106,166,255,.15); }
    button:active{ transform: translateY(1px); }
    table{ width:100%; border-collapse: collapse; font-size:13px; }
    thead th{ position:sticky; top:0; background:#101a3b; }
    th, td{ border-bottom:1px solid #28325f; padding:10px 8px; text-align:right; white-space:nowrap; }
    th:first-child, td:first-child, th:nth-child(2), td:nth-child(2){ text-align:left; }
    .scroll{ max-height: 420px; overflow:auto; border:1px solid #29315b; border-radius:10px; }
    kbd{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#1b2553; color:#e9f0ff; padding:2px 6px; border-radius:6px; border:1px solid #3b4b8a; font-size:12px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:9999px; border:1px solid #3853a0; background:#14214b; font-size:12px; }
    .grid-gap{ margin-top:10px; }
    .sep{ height:8px; }
    .nowrap{ white-space:nowrap; }
    .oneoffs{ margin-top:6px; border-top:1px dashed #2f3c73; padding-top:8px; }
    .footnote{ margin-top:10px; color:#aac3ff99; font-size:12px; line-height:1.65; }
    .success{ color:#a6ffb3; font-weight:600; }
    .total-badge{ padding:4px 8px; border-radius:10px; background:#123f2a; border:1px solid #1c6a43; color:#a3f5c4; font-weight:700; }
    .year-row{ background: #0d1737; font-weight:700; }
    .danger{ background:#3a1420; border-color:#7a3340; }
  </style>
</head>
<body>
  <header>
    <h1>TSMC 分紅與薪資計算器（離線版）</h1>
    <p>
      預設值已依你提供的截圖設定：入職月 1、月薪 63700、季分紅倍數 3、年數 2、調薪 5%、ESPP 3.5%、年終首年按比例、簽約金 30 萬、運動會獎金 2 萬、CSV 檔名 tsmc_income_details.csv。
    </p>
  </header>

  <main>
    <section class="card">
      <div class="head"><h2>參數</h2></div>
      <div class="body">
        <div class="row">
          <div>
            <label>入職月份 (1‒12)</label>
            <input id="joinMonth" type="number" min="1" max="12" value="1">
          </div>
          <div>
            <label>月薪 (NTD)</label>
            <input id="baseSalary" type="number" min="0" step="100" value="63700">
          </div>
        </div>
        <div class="grid-gap"></div>
        <div class="row">
          <div>
            <label>季分紅倍數（以月薪為單位）</label>
            <input id="quarterMult" type="number" min="0" step="0.1" value="3">
          </div>
          <div>
            <label>計算年數</label>
            <input id="years" type="number" min="1" max="40" value="2">
          </div>
        </div>
        <div class="grid-gap"></div>
        <div class="row">
          <div>
            <label>每月固定其他收入 (NTD)</label>
            <input id="otherMonthly" type="number" min="0" step="100" value="0">
          </div>
          <div>
            <label>每年調薪 (%)（於每年 1 月生效）</label>
            <input id="raisePct" type="number" min="0" max="50" step="0.1" value="5">
          </div>
        </div>
        <div class="grid-gap"></div>
        <div class="row">
          <div>
            <label>ESPP 額外收入 (%) 每月（不計入底薪）</label>
            <input id="esppPct" type="number" min="0" max="30" step="0.1" value="3.5">
          </div>
          <div>
            <label>年終是否按比例（僅首年）</label>
            <select id="prorateYearEnd">
              <option value="yes" selected>是</option>
              <option value="no">否</option>
            </select>
          </div>
        </div>

        <div class="grid-gap"></div>
        <div class="row">
          <div>
            <label>入職簽約金 (NTD)</label>
            <input id="signOn" type="number" min="0" step="1000" value="300000">
          </div>
          <div>
            <label>運動會獎金 (NTD)（10 月；限該年 5/31 前在職）</label>
            <input id="sports" type="number" min="0" step="1000" value="20000">
          </div>
        </div>

        <div class="oneoffs">
          <div class="row">
            <div>
              <label>一次性收入 ‑ 年度索引（第幾年，從 1 起）</label>
              <input id="oneYear" type="number" min="1" value="1">
            </div>
            <div>
              <label>月份 (1‒12)</label>
              <input id="oneMonth" type="number" min="1" max="12" value="1">
            </div>
          </div>
          <div class="row">
            <div>
              <label>金額 (NTD)</label>
              <input id="oneAmt" type="number" min="0" step="1000" value="0">
            </div>
            <div>
              <label>說明</label>
              <input id="oneNote" type="text" placeholder="例如：搬家補助">
            </div>
          </div>
          <div class="actions">
            <button id="addOne">＋ 新增一次性收入</button>
            <span class="muted">總筆數：<span id="oneCount">0</span></span>
          </div>
          <div class="scroll" id="oneList" style="margin-top:8px; display:none;"></div>
        </div>

        <div class="grid-gap"></div>
        <div class="row">
          <div>
            <label>CSV 檔名</label>
            <input id="csvName" type="text" value="tsmc_income_details.csv">
          </div>
        </div>

        <div class="actions">
          <button id="calcBtn">計算</button>
          <button id="csvBtn">下載 CSV</button>
          <button id="resetBtn" class="danger">重設為預設值</button>
          <span id="status" class="pill">尚未計算</span>
        </div>

        <div class="footnote">
          <div>⚠️ 本工具為近似試算，實際辦法以公司公告與勞資契約為準；你可自行修改參數以貼近個人情況。</div>
          <div class="sep"></div>
          <div>小技巧：可用 <kbd>Ctrl/⌘ + S</kbd> 直接把本頁存成離線檔；或以 <kbd>python -m http.server</kbd> 起本機伺服器。</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="head"><h2>每月收入明細</h2></div>
      <div class="body">
        <div class="scroll"><table id="monthTbl">
          <thead>
            <tr>
              <th>年</th><th>月</th><th>底薪</th><th>固定其他</th><th>ESPP</th>
              <th>季分紅</th><th>年分紅</th><th>年終</th><th>運動會</th><th>簽約金</th><th>一次性</th><th>合計</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table></div>
      </div>
    </section>

    <section class="card">
      <div class="head"><h2>年度彙總</h2></div>
      <div class="body">
        <div class="scroll"><table id="yearTbl">
          <thead>
            <tr><th>年</th><th>底薪合計</th><th>固定其他</th><th>ESPP</th><th>季分紅</th><th>年分紅</th><th>年終</th><th>運動會</th><th>簽約金</th><th>一次性</th><th>總額</th></tr>
          </thead>
          <tbody></tbody>
        </table></div>
      </div>
    </section>
  </main>

  <script>
    const $ = (s) => document.querySelector(s);
    const byId = (id) => document.getElementById(id);
    const fmt = (n) => n.toLocaleString('zh-Hant-TW', { maximumFractionDigits: 0 });
    const months = [1,2,3,4,5,6,7,8,9,10,11,12];
    const QUARTER_MONTHS = [2,5,8,11]; // 2/5/8/11
    const YEAR_BONUS_MONTH = 7; // 7 月
    const YEAR_END_MONTH = 1;   // 1 月
    const SPORTS_MONTH = 10;    // 10 月

    const state = { oneOffs: [] };

    function saveInputs(){
      const keys = ['joinMonth','baseSalary','quarterMult','years','otherMonthly','raisePct','esppPct','prorateYearEnd','csvName','signOn','sports'];
      const data = {};
      keys.forEach(k => data[k] = byId(k).value);
      data.oneOffs = state.oneOffs;
      localStorage.setItem('tsmc_offline_calc', JSON.stringify(data));
    }
    function loadInputs(){
      const raw = localStorage.getItem('tsmc_offline_calc');
      if(!raw) return;
      try{
        const d = JSON.parse(raw);
        Object.entries(d).forEach(([k,v])=>{
          if(k==='oneOffs'){ state.oneOffs = v || []; renderOneList(); }
          else if(byId(k) && v !== undefined){ byId(k).value = v; }
        });
      }catch{}
    }

    function renderOneList(){
      const box = byId('oneList');
      const cnt = byId('oneCount');
      cnt.textContent = state.oneOffs.length;
      if(state.oneOffs.length===0){ box.style.display='none'; box.innerHTML=''; return; }
      box.style.display='block';
      const rows = state.oneOffs.map((o,i)=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px dashed #2b3a77;">
          <div class="muted">第 <b>${o.y}</b> 年 / <b>${o.m}</b> 月 ｜ <b>${fmt(o.amt)}</b> ｜ ${o.note?o.note:''}</div>
          <button onclick="removeOne(${i})">刪除</button>
        </div>
      `).join('');
      box.innerHTML = rows;
    }
    function removeOne(idx){ state.oneOffs.splice(idx,1); renderOneList(); saveInputs(); }
    byId('addOne').addEventListener('click', () => {
      const y = Math.max(1, parseInt(byId('oneYear').value || '1', 10));
      const m = Math.min(12, Math.max(1, parseInt(byId('oneMonth').value || '1', 10)));
      const amt = Math.max(0, parseFloat(byId('oneAmt').value || '0'));
      const note = byId('oneNote').value.trim();
      if(!Number.isFinite(amt) || amt<=0){ alert('請輸入有效的一次性金額'); return; }
      state.oneOffs.push({y,m,amt,note});
      renderOneList(); saveInputs();
    });

    function compute(){
      // inputs
      const joinMonth   = clampInt(byId('joinMonth').value, 1, 12);
      const years       = clampInt(byId('years').value, 1, 40);
      const quarterMult = clampNum(byId('quarterMult').value, 0, 99);
      const base0       = clampNum(byId('baseSalary').value, 0, 1e12);
      const otherM      = clampNum(byId('otherMonthly').value, 0, 1e12);
      const raisePct    = clampNum(byId('raisePct').value, 0, 100);
      const esppPct     = clampNum(byId('esppPct').value, 0, 100);
      const prorated    = (byId('prorateYearEnd').value === 'yes');
      const signOn      = clampNum(byId('signOn').value, 0, 1e12);
      const sports      = clampNum(byId('sports').value, 0, 1e12);

      saveInputs();

      // salary per year (after January raise)
      const baseOfYear = [];
      baseOfYear[1] = base0;
      for(let y=2; y<=years; y++){
        baseOfYear[y] = Math.round(baseOfYear[y-1] * (1 + raisePct/100));
      }

      // Prepare tables
      const tb = byId('monthTbl').querySelector('tbody');
      const ty = byId('yearTbl').querySelector('tbody');
      tb.innerHTML = ''; ty.innerHTML = '';

      // Track eligibility and yearly sums
      let monthsEmployed = 0; // increments when month >= joinMonth of year 1 onwards
      const sumQuarterByYear = Array(years+2).fill(0); // 1..years

      const yearTotals = Array.from({length: years+1}, ()=> ({base:0, oth:0, espp:0, q:0, yb:0, ye:0, sp:0, so:0, one:0, total:0}));

      // Helper to get any one-off income for y,m
      const oneMap = new Map();
      for(const o of state.oneOffs){
        const key = `${o.y}-${o.m}`;
        oneMap.set(key, (oneMap.get(key)||0) + o.amt);
      }

      for(let y=1; y<=years; y++){
        const baseThisYear = baseOfYear[y];
        for(const m of months){
          const employedThisMonth = (y>1 || m>=joinMonth);
          if(employedThisMonth) monthsEmployed++;

          const base = employedThisMonth ? baseThisYear : 0;
          const espp = employedThisMonth ? Math.round(base * (esppPct/100)) : 0;
          const fixedOther = employedThisMonth ? otherM : 0;

          // Quarterly bonus in 2/5/8/11 if employed >=3 months before/at that month
          let qBonus = 0;
          if(QUARTER_MONTHS.includes(m) && monthsEmployed >= 3 && employedThisMonth){
            qBonus = Math.round(baseThisYear * quarterMult);
            sumQuarterByYear[y] += qBonus;
          }

          // Annual bonus in July equals previous year's total quarterly bonuses
          let yBonus = 0;
          if(m === YEAR_BONUS_MONTH){
            yBonus = (y>1) ? sumQuarterByYear[y-1] : 0;
          }

          // Year-end bonus in January = 2 * previous December's base (first年可選比例)
          let yearEnd = 0;
          if(m === YEAR_END_MONTH && y>1){
            const basePrevDec = baseOfYear[y-1]; // 取前一年的底薪
            let factor = 1;
            if(y===2 && prorated){
              const monthsWorkedY1 = Math.max(0, 12 - (joinMonth - 1)); // 從入職月到 12 月
              factor = monthsWorkedY1 / 12;
            } else if(y===2 && !prorated){
              factor = 1;
            }
            yearEnd = Math.round(basePrevDec * 2 * factor);
          }

          // Sports Day bonus in Oct if joined before 5/31 of that year
          let sportsBonus = 0;
          if(m === SPORTS_MONTH && sports>0){
            const eligibleThisYear = (y>1) ? true : (joinMonth <= 5);
            sportsBonus = eligibleThisYear ? sports : 0;
          }

          // Sign-on only on the very first employed month
          let signOnThis = 0;
          if(y===1 && m===joinMonth && signOn>0){ signOnThis = signOn; }

          const oneOff = oneMap.get(`${y}-${m}`) || 0;

          const monthlyTotal = base + fixedOther + espp + qBonus + yBonus + yearEnd + sportsBonus + signOnThis + oneOff;

          // accumulate year totals
          yearTotals[y].base += base;
          yearTotals[y].oth  += fixedOther;
          yearTotals[y].espp += espp;
          yearTotals[y].q    += qBonus;
          yearTotals[y].yb   += yBonus;
          yearTotals[y].ye   += yearEnd;
          yearTotals[y].sp   += sportsBonus;
          yearTotals[y].so   += signOnThis;
          yearTotals[y].one  += oneOff;
          yearTotals[y].total+= monthlyTotal;

          // render row
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${y}</td><td>${m}</td>
            <td>${fmt(base)}</td><td>${fmt(fixedOther)}</td><td>${fmt(espp)}</td>
            <td>${fmt(qBonus)}</td><td>${fmt(yBonus)}</td><td>${fmt(yearEnd)}</td>
            <td>${fmt(sportsBonus)}</td><td>${fmt(signOnThis)}</td><td>${fmt(oneOff)}</td>
            <td class="success">${fmt(monthlyTotal)}</td>
          `;
          tb.appendChild(tr);
        }
        // Year separator row
        const sep = document.createElement('tr');
        sep.className = 'year-row';
        sep.innerHTML = `<td colspan="12">第 ${y} 年合計 <span class="total-badge">${fmt(yearTotals[y].total)}</span></td>`;
        tb.appendChild(sep);
      }

      // render yearly summary
      for(let y=1; y<=years; y++){
        const t = yearTotals[y];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${y}</td>
          <td>${fmt(t.base)}</td><td>${fmt(t.oth)}</td><td>${fmt(t.espp)}</td>
          <td>${fmt(t.q)}</td><td>${fmt(t.yb)}</td><td>${fmt(t.ye)}</td>
          <td>${fmt(t.sp)}</td><td>${fmt(t.so)}</td><td>${fmt(t.one)}</td>
          <td class="success">${fmt(t.total)}</td>`;
        ty.appendChild(tr);
      }

      byId('status').textContent = '已完成計算';
      byId('status').style.background = '#103e26';
      byId('status').style.borderColor = '#1c6a43';
    }

    function clampInt(v, min, max){ v = parseInt(v || '0', 10); if(!Number.isFinite(v)) v=min; return Math.min(max, Math.max(min, v)); }
    function clampNum(v, min, max){ v = parseFloat(v || '0'); if(!Number.isFinite(v)) v=min; return Math.min(max, Math.max(min, v)); }

    function toCSV(){
      const joinMonth   = clampInt(byId('joinMonth').value, 1, 12);
      const years       = clampInt(byId('years').value, 1, 40);
      const quarterMult = clampNum(byId('quarterMult').value, 0, 99);
      const base0       = clampNum(byId('baseSalary').value, 0, 1e12);
      const otherM      = clampNum(byId('otherMonthly').value, 0, 1e12);
      const raisePct    = clampNum(byId('raisePct').value, 0, 100);
      const esppPct     = clampNum(byId('esppPct').value, 0, 100);
      const prorated    = (byId('prorateYearEnd').value === 'yes');
      const signOn      = clampNum(byId('signOn').value, 0, 1e12);
      const sports      = clampNum(byId('sports').value, 0, 1e12);

      // base per year
      const baseOfYear = [];
      baseOfYear[1] = base0;
      for(let y=2; y<=years; y++){ baseOfYear[y] = Math.round(baseOfYear[y-1]*(1+raisePct/100)); }

      // one-off map
      const oneMap = new Map();
      for(const o of state.oneOffs){
        const key = `${o.y}-${o.m}`;
        oneMap.set(key, (oneMap.get(key)||0) + o.amt);
      }

      let monthsEmployed = 0;
      const sumQuarterByYear = Array(years+2).fill(0);
      const rows = [["年","月","底薪","固定其他","ESPP","季分紅","年分紅","年終","運動會","簽約金","一次性","合計"]];

      for(let y=1; y<=years; y++){
        const baseThisYear = baseOfYear[y];
        for(const m of months){
          const employedThisMonth = (y>1 || m>=joinMonth);
          if(employedThisMonth) monthsEmployed++;

          const base = employedThisMonth ? baseThisYear : 0;
          const espp = employedThisMonth ? Math.round(baseThisYear * (esppPct/100)) : 0;
          const fixedOther = employedThisMonth ? otherM : 0;

          let qBonus = 0;
          if(QUARTER_MONTHS.includes(m) && monthsEmployed >= 3 && employedThisMonth){
            qBonus = Math.round(baseThisYear * quarterMult);
            sumQuarterByYear[y] += qBonus;
          }
          let yBonus = 0;
          if(m === YEAR_BONUS_MONTH){ yBonus = (y>1) ? sumQuarterByYear[y-1] : 0; }

          let yearEnd = 0;
          if(m === YEAR_END_MONTH && y>1){
            const basePrevDec = baseOfYear[y-1];
            let factor = 1;
            if(y===2 && prorated){
              const monthsWorkedY1 = Math.max(0, 12 - (joinMonth - 1));
              factor = monthsWorkedY1 / 12;
            }
            yearEnd = Math.round(basePrevDec * 2 * factor);
          }

          let sportsBonus = 0;
          if(m === SPORTS_MONTH && sports>0){
            const eligibleThisYear = (y>1) ? true : (joinMonth <= 5);
            sportsBonus = eligibleThisYear ? sports : 0;
          }

          let signOnThis = 0;
          if(y===1 && m===joinMonth && signOn>0){ signOnThis = signOn; }

          const oneOff = oneMap.get(`${y}-${m}`) || 0;
          const monthlyTotal = base + fixedOther + espp + qBonus + yBonus + yearEnd + sportsBonus + signOnThis + oneOff;

          rows.push([y, m, base, fixedOther, espp, qBonus, yBonus, yearEnd, sportsBonus, signOnThis, oneOff, monthlyTotal]);
        }
      }
      const csv = rows.map(r => r.map(x => (typeof x === 'string' ? `"${x.replace(/"/g,'""')}"` : x)).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const fname = (byId('csvName').value || 'tsmc_income_details.csv').replace(/[\\/:*?"<>|]+/g,'_');
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // Reset to default values (matching the screenshot)
    function resetDefaults(){
      const defaults = {
        joinMonth: 1, baseSalary: 63700, quarterMult: 3, years: 2,
        otherMonthly: 0, raisePct: 5, esppPct: 3.5, prorateYearEnd: 'yes',
        csvName: 'tsmc_income_details.csv', signOn: 300000, sports: 20000
      };
      Object.entries(defaults).forEach(([k,v]) => { if(byId(k)) byId(k).value = v; });
      state.oneOffs = [];
      renderOneList();
      localStorage.removeItem('tsmc_offline_calc');
      byId('status').textContent = '已重設為預設值（尚未計算）';
      byId('status').className = 'pill';
    }

    byId('calcBtn').addEventListener('click', compute);
    byId('csvBtn').addEventListener('click', toCSV);
    byId('resetBtn').addEventListener('click', resetDefaults);
    window.addEventListener('beforeunload', saveInputs);
    loadInputs();
  </script>
</body>
</html>
"""
path = "/mnt/data/tsmc_bonus_calculator_offline.html"
with open(path, "w", encoding="utf-8") as f:
    f.write(html)
path
